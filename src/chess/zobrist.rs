
use super::*;
pub use std::io::Write;
pub use std::fs::File;

impl Chess {
    
    pub fn piece_hash(&mut self, piece_type: PieceType, colour_index: usize, square: Square) {
        let mut index: usize = colour_index * 6 * 64;
        index += piece_type.piece_index() * 64;
        index += square as usize;
        self.hash ^= PIECE_MASK[index];
    }
    pub fn black_turn_hash(&mut self) {
        self.hash ^= BLACK_TURN_MASK;
    }
    pub fn castling_hash(&self, hash: u32) -> u32 {
        hash ^ CASTLING_MASK[self.castling as usize]
    }
    pub fn en_passant_hash(&self, hash: u32) -> u32 {
        if self.en_passant == -1 {return hash}
        hash ^ EN_PASSANT_MASK[(self.en_passant % 8) as usize]
    }
}


#[allow(unused)]
pub fn generate_random_number_masks() {
    use rand::*;
    let mut rng = rand::thread_rng();
    
    let piece_mask_len = 2 * 6 * 64;
    let black_turn_mask_len = 1;
    let castling_mask_len = 16;
    let en_passant_mask_len = 8;
    let mut numbers_for_zobrist = File::create("/home/di77i/numbers_for_zobrist.txt").unwrap();

    numbers_for_zobrist.write("--- PIECE MASK ---\n".as_bytes());
    for x in 0..piece_mask_len {
        numbers_for_zobrist.write(rng.next_u32().to_string().as_bytes());
        numbers_for_zobrist.write("\n".as_bytes());
    }

    numbers_for_zobrist.write("\n--- BLACK TURN MASK ---\n".to_string().as_bytes());
    for x in 0..black_turn_mask_len {
        numbers_for_zobrist.write(rng.next_u32().to_string().as_bytes());
        numbers_for_zobrist.write("\n".as_bytes());
    }
    
    numbers_for_zobrist.write("\n--- CASTLING MASK ---\n".to_string().as_bytes());
    for x in 0..castling_mask_len {
        numbers_for_zobrist.write(rng.next_u32().to_string().as_bytes());
        numbers_for_zobrist.write("\n".as_bytes());
    }
    
    numbers_for_zobrist.write("\n--- EN PASSANT MASK ---\n".to_string().as_bytes());
    for x in 0..en_passant_mask_len {
        numbers_for_zobrist.write(rng.next_u32().to_string().as_bytes());
        numbers_for_zobrist.write("\n".as_bytes());
    }
}


#[cfg(test)]
mod zobrist_hash_tests {
    use std::time::*;

    use super::*;

    #[test]
    fn test_1() {
        let mut chess = Chess::start_position();
        let start_hash = chess.hash();
        chess.piece_hash(BISHOP, 1, 43);
        chess.piece_hash(QUEEN, 0, 4);
        chess.piece_hash(BISHOP, 1, 43);
        chess.piece_hash(QUEEN, 0, 4);
        assert_eq!(start_hash, chess.hash());
    }
    #[test]
    fn test_2() {
        let mut chess = Chess::start_position();
        let start_hash = chess.hash();
        chess.piece_hash(BISHOP, 1, 43);
        chess.piece_hash(QUEEN, 0, 4);
        chess.piece_hash(BISHOP, 1, 43);
        assert_ne!(start_hash, chess.hash());
    }
    #[test]
    fn test_3() {
        let mut chess = Chess::start_position();
        let start_hash = chess.hash();
        let r#move = Move::new(1, 18, NO_FLAG);
        chess.make_move(r#move);
        chess.unmake_move(r#move);
        assert_eq!(start_hash, chess.hash());
    }
    #[test]
    fn test_4() {
        let mut chess = Chess::start_position();
        let start_hash = chess.hash();
        chess.make_move(Move::new(1, 18, NO_FLAG));
        chess.make_move(Move::new(57, 40, NO_FLAG));
        chess.make_move(Move::new(18, 1, NO_FLAG));
        chess.make_move(Move::new(40, 57, NO_FLAG));
        assert_eq!(start_hash, chess.hash());
    }
    #[test]
    fn test_5() {
        let mut chess = Chess::start_position();
        let start_hash = chess.hash();
        chess.perft_bulck(5);
        assert_eq!(start_hash, chess.hash());
    }
}
const PIECE_MASK: [u32; 2 * 6 * 64] = [
    13535600,
    1717510150,
    2452622645,
    2482275850,
    1497315448,
    1187235673,
    468176938,
    4136904292,
    4257656868,
    3645022140,
    789331580,
    3952774260,
    3242172483,
    368549256,
    3584789011,
    578187017,
    169130504,
    322919963,
    2514106258,
    2154010171,
    774446760,
    1118100104,
    1388124294,
    2440491604,
    2163274113,
    354177160,
    1495257277,
    2886377906,
    1533287476,
    2900915135,
    2281516135,
    1072243537,
    1988492632,
    3776855908,
    4033803111,
    1993146316,
    3166243677,
    1676329858,
    1406154395,
    2516332882,
    2322063886,
    1244758976,
    1957246278,
    2808011859,
    1976845538,
    4053620604,
    2095387389,
    2240806439,
    349090066,
    4243398769,
    102351999,
    741169536,
    357088793,
    2861383620,
    2042681018,
    3305362047,
    1849470177,
    2621574421,
    1855514178,
    1781453331,
    2430614591,
    1593168894,
    1127970247,
    2224758965,
    4075632089,
    907668653,
    4139130858,
    3620606930,
    536907324,
    81020810,
    973278826,
    1331082007,
    2141714759,
    4207353198,
    2556079459,
    2247438867,
    4150849623,
    1631094938,
    3031530880,
    969396403,
    2417775822,
    3149706416,
    326255519,
    4187499796,
    4163394558,
    2651460158,
    436189310,
    2099575328,
    3250083597,
    4023926327,
    745367754,
    3342202034,
    3974640733,
    3345780580,
    3291472098,
    4046396416,
    1365138653,
    2281741375,
    2034390983,
    2445010913,
    1031120318,
    3031450970,
    3956267441,
    1468831065,
    1543788027,
    1545881876,
    945045765,
    2862254550,
    185878889,
    3069052487,
    3353869496,
    899363035,
    880783184,
    4014782787,
    3218419227,
    1504681626,
    4211315611,
    4277678105,
    2308876844,
    2919301276,
    3436644807,
    411052595,
    2250452483,
    4281043215,
    3350249282,
    871063087,
    3564825774,
    2076456820,
    3693286744,
    282889150,
    3389409481,
    1804755445,
    68741208,
    2188368768,
    78322895,
    3590761541,
    3466196215,
    1557818763,
    1726027047,
    3729286478,
    870478242,
    2310413453,
    1353690581,
    2667119526,
    3053363361,
    3723618575,
    1200170029,
    3710373486,
    3352678383,
    1771234782,
    4123905080,
    3326142349,
    2419191988,
    3277741414,
    2353573689,
    1564047977,
    1803184700,
    326407009,
    260243297,
    973641627,
    2848895020,
    2767971470,
    4220496614,
    2763624788,
    4023937984,
    861664316,
    938214008,
    3770863886,
    796151853,
    1913176070,
    1785414927,
    2867343412,
    2516852919,
    4023888008,
    2519393142,
    4063543122,
    4028703527,
    943709162,
    4124214663,
    1267474006,
    2467776278,
    331941442,
    1626208470,
    1121771938,
    3143749388,
    2702134932,
    258736097,
    1707199603,
    665474416,
    333348063,
    336048319,
    660475743,
    4223707715,
    2664024551,
    1403005103,
    703154178,
    476519943,
    2298142463,
    910152908,
    1497522056,
    1045770465,
    1355197784,
    1090121859,
    2760923775,
    1750033813,
    8147459,
    21868086,
    3670734268,
    3660361392,
    524092956,
    4095820481,
    2093082670,
    1941263380,
    4044934606,
    1158639143,
    383633971,
    3174648050,
    1396599259,
    2589415928,
    3513550756,
    3532755334,
    1892005172,
    754495990,
    906235109,
    3251873182,
    2387403587,
    3915406953,
    3946005167,
    1175376829,
    3530127642,
    4113956905,
    1393232928,
    3122996318,
    585490281,
    2073864865,
    2116328074,
    1244645376,
    2365539680,
    2416649499,
    3764753127,
    1669567117,
    4259936257,
    176153977,
    1753917811,
    2866296254,
    2334576687,
    2741551095,
    2584243997,
    1955973980,
    3840111737,
    1107725419,
    4204756527,
    1941405681,
    1148046889,
    572373439,
    583201699,
    2359217818,
    3430877805,
    770912412,
    816187932,
    789224105,
    1049779086,
    2455727152,
    743126309,
    1845093923,
    2722152008,
    2272438498,
    315497541,
    4000690407,
    1235313913,
    1667244901,
    1590384365,
    1423314070,
    2949016185,
    209711317,
    897045418,
    135637500,
    1672147486,
    1343432401,
    3262944349,
    2571681089,
    332996902,
    2146066329,
    3348858254,
    908784460,
    3819246666,
    3372071969,
    906952169,
    2408864590,
    1384470314,
    363959412,
    2058400016,
    1254319961,
    909032222,
    3457526020,
    640737188,
    4073316979,
    654907391,
    1713686060,
    648615195,
    160144024,
    47188247,
    3179983324,
    304634676,
    47712312,
    846494960,
    1889813682,
    4245560206,
    3537536737,
    1894224769,
    2210539713,
    4111872775,
    2375696269,
    4099889975,
    3041327513,
    2453392615,
    1533090839,
    2846195045,
    2058636613,
    1994895807,
    2062723952,
    337978703,
    1543358851,
    1134983090,
    1297634714,
    608182687,
    1402654702,
    2622043690,
    1017994537,
    3899442140,
    3356632345,
    2013668543,
    3012637660,
    4129816995,
    1593936217,
    691922665,
    1002654540,
    2377657908,
    2047536623,
    2572195780,
    1306302861,
    1209879418,
    3330251391,
    3112578310,
    1358377614,
    2589364406,
    388576446,
    2904616037,
    1541323053,
    4024457982,
    962749776,
    2752993240,
    12120629,
    414757377,
    1323200677,
    3120627074,
    3583832145,
    2684910344,
    197507975,
    556950783,
    2482208437,
    4099586432,
    631452586,
    3399021536,
    4073803125,
    3751492251,
    270201435,
    3099052807,
    1417414178,
    1438299908,
    4159299106,
    1535765529,
    3447258559,
    582166354,
    1471027646,
    181889879,
    1611600199,
    703874023,
    3978526679,
    1313603400,
    1040233362,
    2398249508,
    1955877357,
    2835421597,
    2871188213,
    1833810755,
    197154045,
    1133871094,
    1349566622,
    2425078921,
    1849379185,
    3406793967,
    3419455369,
    3675400393,
    623735385,
    2760603579,
    2713724029,
    1535082302,
    3854113100,
    1902695820,
    199853680,
    3650774740,
    443132838,
    2805613170,
    2988139960,
    281627511,
    3947088407,
    3338013448,
    695644431,
    3606068091,
    3317617260,
    2162635559,
    184245334,
    2007234966,
    1921481709,
    2213467625,
    157631691,
    2846919718,
    3632957974,
    2433308772,
    1413490662,
    510119719,
    426505742,
    105547444,
    4139281045,
    3183808300,
    54135510,
    3986958769,
    3666470660,
    2007858635,
    2109165914,
    1799522472,
    481439438,
    2255070354,
    1314252212,
    60738932,
    343980009,
    4273405375,
    357259563,
    508269372,
    3579303817,
    3737091529,
    300636749,
    4190427692,
    327312543,
    338214305,
    1838910238,
    3531604706,
    3283689242,
    2507268671,
    3152406625,
    1650688426,
    2541345933,
    616939249,
    2976404773,
    1428679954,
    249796993,
    2698286877,
    348810627,
    3860296003,
    2155366948,
    3247800451,
    3788233239,
    665092468,
    1621959215,
    370945888,
    1086436118,
    898309813,
    3131477194,
    79896855,
    2379617219,
    1360094579,
    2252344030,
    2622718243,
    1471868409,
    2452159227,
    1019281247,
    3586536435,
    2054950941,
    312531623,
    2229302540,
    2664191984,
    3865754584,
    3047524095,
    1849674150,
    3608777017,
    107307152,
    2252747437,
    2200712726,
    3391891398,
    3752912990,
    1342026232,
    2970057679,
    3224017052,
    725133529,
    1486039453,
    2749950215,
    3504244165,
    3997854358,
    2494884971,
    388136311,
    1283154056,
    2807361675,
    881374531,
    783826842,
    3921635327,
    1600049076,
    3087180586,
    2022212847,
    3487782558,
    1969740017,
    3818127274,
    2330690949,
    3594953037,
    3867681929,
    1664021122,
    2537721030,
    537069142,
    2550448088,
    1249824993,
    2421000076,
    1158359744,
    210405863,
    400394518,
    2358731601,
    704405452,
    3685780683,
    2085097353,
    3421160697,
    3600220150,
    3657028662,
    4228370456,
    1348501222,
    45986684,
    3862591680,
    665281306,
    3551970125,
    2137025817,
    2880247186,
    2749650788,
    1607941699,
    2948147580,
    4152068888,
    2762949649,
    2630420381,
    512791179,
    2307344613,
    1656594274,
    3638861571,
    1038086727,
    3076272125,
    742485061,
    2651251443,
    3318857641,
    3643494170,
    3598596606,
    982714814,
    3498567857,
    1209936305,
    2665887594,
    1242116627,
    1303839154,
    4280307257,
    3941887673,
    2774793840,
    1794816091,
    1531173756,
    1377676616,
    3167739902,
    928916324,
    14348491,
    3509991523,
    1786046312,
    981989988,
    719870829,
    1230438143,
    717923282,
    1705144194,
    3669909848,
    3585429856,
    457033812,
    1507206505,
    1949314069,
    3391524194,
    2570339144,
    3698641243,
    3802675190,
    2452001088,
    139368744,
    923921166,
    2305708376,
    974496803,
    4266292069,
    1020186989,
    540300771,
    657091856,
    1803765088,
    179446294,
    861152246,
    2138871228,
    4223895730,
    3305795656,
    76415419,
    3450102733,
    2074013019,
    2414087433,
    242466408,
    2745663146,
    2311372823,
    1878032301,
    1398173034,
    2672719168,
    2734344389,
    980836129,
    416300431,
    920167980,
    553148964,
    184449393,
    593324194,
    1503780645,
    3192069900,
    2532659046,
    1121691702,
    2292536542,
    1785760255,
    3736569633,
    2959807164,
    2642057530,
    1187981741,
    1881144558,
    2685193943,
    3458469081,
    897374874,
    2420756064,
    3402369100,
    2823977125,
    1598751423,
    956775123,
    2947484871,
    552192633,
    3249867027,
    2319555971,
    522756495,
    3603610938,
    3278305559,
    1067424588,
    997718324,
    670785514,
    332124093,
    2689577671,
    1759613445,
    2536128650,
    2519130835,
    726662260,
    3322848326,
    1589128874,
    2354293981,
    854196119,
    1522510333,
    3703126937,
    3806921519,
    3558913496,
    1309052049,
    1897574452,
    2353792909,
    560494744,
    2958213779,
    1012699686,
    3730714440,
    877746215,
    3816874644,
    1968953615,
    1450068509,
    216508959,
    36301621,
    468089232,
    2542456087,
    1780226461,
    1199066472,
    1455538660,
    4162264034,
    2760075853,
    1960312649,
    3399900466,
    1503812956,
    2799604146,
    1159173057,
    2971747784,
    2122123724,
    2288928201,
    256373253,
    4019230252,
    3270490268,
    2485847223,
    3068430070,
    3719144000,
    601811611,
    3898631383,
    365230648,
    3779838433,
    1277629708,
    3567565794,
    3759718505,
    2037938094,
    2209718671,
    3524672603,
    626950507,
    1120407931,
    3914372453,
    186287982,
    304659699,
    1898744042,
    3852134467,
    3282079305,
    1798158716,
    1208745662,
    2939919604,
    1472360226,
    1084234811,
    1584611288,
    1076812730,
    2409772584,
    3985612494,
    620562212,
    832776528,
    68275385,
    3861079032,
    3697522565,
    1683807895,
    3793981526,
    2495686427,
    3862868843,
    304903762,
    4123289481,
    2427406672,
    3684296097,
    3437284940,
    3597540087,
    673582601,
    4197235917,
    1338508769,
    60666913,
    4109225012,
    2969824218,
    2158550292,
    1388446197,
    3929999191,
    1778542602,
    2793345802,
    4278622134,
    2517707293,
    1746275113,
    3348118329,
    3163783494,
    2248933673,
    2948344027,
    1160634279,
    4212210555,
    2639729565,
    396202337,
    3981849373,
    2632292478,
    3932050669,
    1557203649,
    1398481840,
    3680188474,
    2467606736,
    662040103,
];
const BLACK_TURN_MASK: u32 = 4213725700;
const CASTLING_MASK: [u32; 16] = [
    1299668521,
    1857414931,
    17037470,
    1010465177,
    3046335269,
    3867174671,
    536826547,
    3777045685,
    1003615859,
    2695308159,
    2758684253,
    4081007353,
    2967663400,
    3943927336,
    989457527,
    1634318449,
];
const EN_PASSANT_MASK: [u32; 8] = [
    2828692055,
    103341048,
    243865246,
    3135840470,
    3469259273,
    2802492943,
    3823365064,
    2179643080,
];