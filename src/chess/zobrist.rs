
use super::*;
pub use std::io::Write;
pub use std::fs::File;

pub type Hash = u64;

impl Chess {
    
    pub fn piece_hash(&mut self, piece_type: PieceType, colour_index: usize, square: Square) {
        let mut index: usize = colour_index * 6 * 64;
        index += piece_type.piece_index() * 64;
        index += square as usize;
        self.hash ^= PIECE_MASK[index];
    }
    pub fn black_turn_hash(&mut self) {
        self.hash ^= BLACK_TURN_MASK;
    }
    pub fn castling_hash(&self, hash: Hash) -> Hash {
        hash ^ CASTLING_MASK[self.castling as usize]
    }
    pub fn en_passant_hash(&self, hash: Hash) -> Hash {
        if self.en_passant == -1 {return hash}
        hash ^ EN_PASSANT_MASK[(self.en_passant % 8) as usize]
    }
}


#[allow(unused)]
pub fn generate_random_number_masks() {
    use rand::*;
    let mut rng = rand::thread_rng();
    
    let piece_mask_len = 2 * 6 * 64;
    let black_turn_mask_len = 1;
    let castling_mask_len = 16;
    let en_passant_mask_len = 8;
    let mut numbers_for_zobrist = File::create("/home/di77i/numbers_for_zobrist.txt").unwrap();

    numbers_for_zobrist.write("--- PIECE MASK ---\n".as_bytes());
    for x in 0..piece_mask_len {
        numbers_for_zobrist.write(rng.next_u64().to_string().as_bytes());
        numbers_for_zobrist.write("\n".as_bytes());
    }

    numbers_for_zobrist.write("\n--- BLACK TURN MASK ---\n".to_string().as_bytes());
    for x in 0..black_turn_mask_len {
        numbers_for_zobrist.write(rng.next_u64().to_string().as_bytes());
        numbers_for_zobrist.write("\n".as_bytes());
    }
    
    numbers_for_zobrist.write("\n--- CASTLING MASK ---\n".to_string().as_bytes());
    for x in 0..castling_mask_len {
        numbers_for_zobrist.write(rng.next_u64().to_string().as_bytes());
        numbers_for_zobrist.write("\n".as_bytes());
    }
    
    numbers_for_zobrist.write("\n--- EN PASSANT MASK ---\n".to_string().as_bytes());
    for x in 0..en_passant_mask_len {
        numbers_for_zobrist.write(rng.next_u64().to_string().as_bytes());
        numbers_for_zobrist.write("\n".as_bytes());
    }
}


#[cfg(test)]
mod zobrist_hash_tests {
    use std::time::*;

    use super::*;

    #[test]
    fn test_1() {
        let mut chess = Chess::start_position();
        let start_hash = chess.hash();
        chess.piece_hash(BISHOP, 1, 43);
        chess.piece_hash(QUEEN, 0, 4);
        chess.piece_hash(BISHOP, 1, 43);
        chess.piece_hash(QUEEN, 0, 4);
        assert_eq!(start_hash, chess.hash());
    }
    #[test]
    fn test_2() {
        let mut chess = Chess::start_position();
        let start_hash = chess.hash();
        chess.piece_hash(BISHOP, 1, 43);
        chess.piece_hash(QUEEN, 0, 4);
        chess.piece_hash(BISHOP, 1, 43);
        assert_ne!(start_hash, chess.hash());
    }
    #[test]
    fn test_3() {
        let mut chess = Chess::start_position();
        let start_hash = chess.hash();
        let r#move = Move::new(1, 18, NO_FLAG);
        chess.make_move(r#move);
        chess.unmake_move(r#move);
        assert_eq!(start_hash, chess.hash());
    }
    #[test]
    fn test_4() {
        let mut chess = Chess::start_position();
        let start_hash = chess.hash();
        chess.make_move(Move::new(1, 18, NO_FLAG));
        chess.make_move(Move::new(57, 40, NO_FLAG));
        chess.make_move(Move::new(18, 1, NO_FLAG));
        chess.make_move(Move::new(40, 57, NO_FLAG));
        assert_eq!(start_hash, chess.hash());
    }
    #[test]
    fn test_5() {
        let mut chess = Chess::start_position();
        let start_hash = chess.hash();
        chess.perft_bulck(5);
        assert_eq!(start_hash, chess.hash());
    }
}
const PIECE_MASK: [Hash; 2 * 6 * 64] = [
    12398463311076892563,
    6733599862865338357,
    17955739164139862960,
    4227889825071039805,
    10315898121847975028,
    7372989017361177900,
    16099029073517383236,
    11698146147046892660,
    12816221317810148155,
    3374785571138381806,
    6116400157173489793,
    14348466577466036958,
    4070514640374434332,
    2957056694097361354,
    2977377502281788710,
    4840189825056642247,
    6678549840451056017,
    4019633265331861233,
    17924423160561797492,
    15068167682588636982,
    17240026254405321179,
    11525565273886008626,
    14310802925615712346,
    7728604197258975990,
    2712994666075176685,
    12476417425079154077,
    11205824751785745274,
    14159891864752287607,
    13194514506263436670,
    14083055556447862802,
    17977923685315682781,
    2725550626472722446,
    9031629250673236482,
    1500315077949520854,
    16513771157936236266,
    9128163034455885865,
    7570243425615390047,
    17649959789444679456,
    4708550089315359159,
    9071301621114877497,
    15370759980987097158,
    1569324143500084160,
    1328816200452439121,
    4442277266692512749,
    1376798747115841454,
    3640808810753377804,
    11014638287541529641,
    5062998842158596998,
    11322510232397373785,
    15918731191286007484,
    1652245107316096229,
    15727307763615469334,
    146209317885972034,
    15182959665213567287,
    617021419331415457,
    14036376677521672384,
    9630746159269082037,
    15330336426410700657,
    8811108148965384765,
    7040303427071213778,
    17166432391949410159,
    2252555807601358911,
    4511619144961446644,
    15234105252332102504,
    11368981055131181404,
    8914700331753468034,
    10703648507244408160,
    10703669237819656487,
    5363395153638489125,
    14707661219126192429,
    13177616257383421511,
    7850658413860054316,
    11530883051968428374,
    17266680785084731964,
    2705552000625634336,
    12644472682686571358,
    7979998160090457527,
    1229821454203347351,
    6158118019880317056,
    14037213272138548007,
    15248453189242995797,
    12068637518887721563,
    8501239782786598238,
    17596734773140229255,
    12331140121701291251,
    9369024637254659203,
    5610904581157858551,
    2800378814736136359,
    9779507575934058466,
    5760720184310236897,
    5144754155536919562,
    9841063283637687483,
    771121987978023572,
    4933081275123517490,
    14430789640014384113,
    7435640169319244573,
    12849204789828798042,
    16648936263327942545,
    5698643617905695361,
    11538722241849939403,
    5965621406683907548,
    5411326000879847029,
    11845142122829975843,
    11271011107834274823,
    14409361858576050519,
    16552326467316488408,
    18409061303949441682,
    17229196067308195789,
    2923890883416208398,
    12373086997747683552,
    12039899845274746267,
    18005708399757382056,
    10599472286700247544,
    4321986017482628647,
    16002817170338059488,
    10957179980174607019,
    3987636923085780094,
    15898914451918169101,
    10770801401049572776,
    4619395621125726576,
    734058066326381553,
    6582223859095900922,
    3859420553417733676,
    17689893117931005517,
    15460862488449993308,
    17196452318584681776,
    7050830085591150492,
    2574044976163598047,
    10901338415531666030,
    1128478744123034865,
    2913012750097330783,
    17730084013362127022,
    1513960396916134393,
    15895118418614982302,
    511713389939422415,
    7313470178516387467,
    11467027586324815123,
    8089409169389996610,
    11033811758403022112,
    2628829421966793555,
    1169009390234942683,
    4702826621481175161,
    18118576618918575052,
    16309668799497634418,
    221267007082020319,
    13299260868684230573,
    12001265013839274768,
    9108873075517329634,
    10984057362185132189,
    6758667611672198282,
    14095529612174060562,
    713064389447015267,
    4861609942808203310,
    5192961995027132010,
    13448692404072731372,
    12880734555065557963,
    16475856695013795457,
    2694718348851957198,
    16073007217632076323,
    5552995535905080281,
    12786866995306402976,
    6312396733312381013,
    12843800844558658036,
    14292949471322153493,
    1333291746887236068,
    4627322609601527822,
    1566092152294521971,
    8408649592355469490,
    11448142092494958789,
    7345113359852461769,
    12245258502609423005,
    15165215199280330395,
    4805702033481256420,
    13636080179009260994,
    3255891003440317014,
    5772133360273331899,
    12578046632025728007,
    3212897243474798904,
    10888527380229058022,
    13197932428701557001,
    5426883609472676392,
    16727552712317305663,
    10067183013621894687,
    2623760032855311782,
    18153211798385805977,
    11187397504664427113,
    686002400242754644,
    11692679412500489448,
    9404449131412927836,
    15189345103301781974,
    16140116927444558321,
    1628500102348392809,
    14349535668782299280,
    18436023299934111405,
    17014767906250956037,
    11372730785888094457,
    14363911565380752818,
    1167202572387294619,
    13109434982025759663,
    13607527932015028423,
    6244538542567627447,
    1811679324199111329,
    15695765928973517601,
    14845587386943684395,
    6977810868095255569,
    11408907307976884780,
    13280373112336682741,
    10017969272209581723,
    6628269064738592810,
    6664671695483512750,
    7887117143010650398,
    17492545157281068300,
    3264113816062487319,
    5684602042475339012,
    2336530171734297266,
    973518482350906856,
    4775176213659825351,
    15538632632782245666,
    6285025956734779264,
    9878289021512119709,
    3391545011166822924,
    6063992164560599940,
    16256186440646676948,
    219151874502536410,
    7311944114626068412,
    696043669929696756,
    15278026249527644811,
    2781618928749118203,
    7980689545378360238,
    16798748251572184691,
    16418998268765560932,
    2573772924973968489,
    10868452422412029907,
    10129132032877400679,
    12693290454804235094,
    13568373023228654848,
    17620668592046514802,
    6089665520070398319,
    2985501719779458753,
    304196478874602349,
    212206313861210934,
    8552017238248433025,
    9349481390050405853,
    18009553794867369256,
    5355350617377563346,
    11656110890945546334,
    17216352918726620681,
    3536758304524848747,
    11795670780876544456,
    3987225434167694522,
    16092500887558692039,
    15550148206565849268,
    6628492964372847542,
    18405691931089029559,
    17882701538941828128,
    5332013284348799009,
    5021752612196235720,
    2614445842720281602,
    16862248787215362344,
    7553463742627556897,
    16074793284091419727,
    2666210644620816007,
    10306925680107649011,
    12441561419559075584,
    5478589788817199657,
    10351580658052724194,
    7386294138321408392,
    1815400633074374131,
    2875218879324893377,
    9915867518673875181,
    9057904835351511962,
    1265535840396696549,
    12304334771567342159,
    7466123438475287114,
    4609497479721298567,
    13775526624243984927,
    14040327856488422230,
    5296635448941512539,
    15835117499306847837,
    3866852764219131666,
    14003684120930765042,
    7906306259967183364,
    8834560603853541984,
    5364761436215167552,
    9016578453950891116,
    13103534628787007240,
    10906750390903966159,
    987678711977642934,
    9486980991348720730,
    18276252502470044638,
    15416786474779969896,
    12795509025921590502,
    6417335485334975139,
    8303071418538181576,
    12643298190830876999,
    14530548534919060435,
    11775895959591157599,
    1905557102899157661,
    17461560812629465632,
    7491914873050561946,
    12734816821265876124,
    14136595984886733871,
    14200785549953330438,
    14844669304781116615,
    15687209506496509349,
    5020193334969564235,
    16398138381166499326,
    1530192054782714359,
    5772812200668279048,
    3811955057953078844,
    13724647874218976844,
    5751669684522656138,
    11378154654486272981,
    15999080834898172002,
    8350494092744739204,
    13814115191512051569,
    14182945091523139961,
    11430382997069899859,
    6593198766096151887,
    3112235552571489895,
    129852183902621101,
    12514700540499198795,
    16246011757584249968,
    3937385573333310358,
    11636132704211317979,
    14174174654660762167,
    10454205370215512107,
    791006151255371867,
    12788284915833874159,
    15763999326439826799,
    7900125865885764775,
    13285662158476429995,
    11185578624509062426,
    3031672145885382929,
    2802344879078642732,
    12209193304815380458,
    10527454249043732525,
    14925251883574908088,
    14748912276586859984,
    8880231500418696075,
    1367834224276431600,
    17868558888426079521,
    343119456637810570,
    7825226398100942906,
    18103817624143228702,
    2286684177860913820,
    6930314604352202076,
    9403391078590812379,
    6539345713633448458,
    8863928996132122218,
    14400338257233993022,
    1781374081510876406,
    15986324366661391715,
    9519662159550633166,
    9926358085555597637,
    3407837291079962443,
    17462999147370727109,
    10143415452568253332,
    14788853414113535257,
    12056265434255935176,
    18335176348513553903,
    7857483194178881439,
    10048097631285775878,
    3951416886342278520,
    10030224249300868472,
    15002908312945109286,
    4933831351867727177,
    10421641427377401321,
    10948065199629606136,
    6105235646272154594,
    3809258847787177629,
    11955046134120609852,
    4506712410339162765,
    2607784845793151819,
    10781532936150070239,
    9405212605239786919,
    15146924147646417331,
    5042398426774659662,
    6849176978682243073,
    5414649603410617975,
    12902184993849836866,
    12524750635756160377,
    17004521190534447981,
    2310342373997393130,
    3881952799934526728,
    5383141810812328416,
    13401924957853138790,
    12872125860854263053,
    13054870262968834562,
    10232436456527768890,
    1614576890471983961,
    7830922945035874432,
    7916443359963554928,
    5078563726324529579,
    10886151931461463587,
    2172056499780313780,
    947387653989016977,
    14813042367780704878,
    4787701706857191777,
    2294924136932302156,
    10714327092018915858,
    13611808739252333062,
    17927192413878830887,
    15679074029132367539,
    18065732672650614590,
    948261416992315301,
    18041099216231862225,
    15698562416729876547,
    313379481058607682,
    16212311466400262866,
    10139022135383901629,
    14715704219708622619,
    8565046606751508835,
    3406285151432233316,
    14060709451726160161,
    3962697325417762810,
    14403794597617809512,
    9094634422563608721,
    18221719418544829570,
    152643092588821588,
    11953458240504703587,
    2263262939323253997,
    9449753869161658270,
    1322361506054452940,
    3453563077304880630,
    5287067036136870836,
    12342141679049578072,
    1252966674383394803,
    3061874213414751851,
    5386488403448779752,
    1926087290469359931,
    12590298033916244278,
    15462442174954179260,
    8468879467810624450,
    1818506086518645705,
    8693204254196078870,
    4370464313363408760,
    549912294889365348,
    1315439784624123734,
    3859384627158896775,
    14728151181962276808,
    12685477776791032264,
    5851054637786200585,
    17116759168524226515,
    10829803012417856669,
    12608402337212564282,
    16722554422578889253,
    11957379887959300809,
    13711434452515390886,
    1101052434167576189,
    8027709341665932369,
    12300806897229685075,
    1553404014772391385,
    13872649324443963977,
    2426671998823752181,
    12388478538132878415,
    121415927308531289,
    1496154561152662711,
    12764681139508803245,
    2310947760000351076,
    10751614073455615264,
    16019555705740170646,
    5540226504481319222,
    7985678844945902605,
    17459086469186006064,
    13073048581365460420,
    10256006522282303869,
    5202261011690781540,
    8251117720833036360,
    3750575238424028846,
    6479675974635987227,
    3507687779537915589,
    1269287870589167603,
    10026762773116942967,
    16096591770943798734,
    6147387763797042814,
    15903354389076686840,
    14404806905718679252,
    16286646363382493686,
    9495213673059419118,
    14088797195102068950,
    10148617965884216087,
    4241242659671700335,
    5183206314266164585,
    12452041047941629921,
    12064947964503170694,
    8890573326213340515,
    13808380742501205840,
    11701654645132474721,
    14311969213790363381,
    10143914118416524992,
    12998326105388395826,
    15841904522463140791,
    3612253909284886058,
    7500334553471171410,
    9742645793474925084,
    8111654266508716111,
    460220958887322554,
    17532771471582280375,
    14075171798781480861,
    18367852130820500395,
    6465773463936512382,
    3714834810990747047,
    16742971200931289707,
    8982195667098024284,
    601949049052876479,
    10095898620475030946,
    13742597731399391940,
    7956645684234458102,
    3592639191603181548,
    15744836798969589294,
    2817751827086900042,
    92422064152217693,
    17901447429253574935,
    9687818825697036893,
    5234759875095282281,
    11892931415560330131,
    13761944774420742220,
    9584775226149351959,
    1438487093904797193,
    14568647748250016210,
    14127576449434252225,
    16135107705698007245,
    10134533570760619230,
    10907354845435997017,
    6664437900052738476,
    10770568114026733401,
    15462466171544825477,
    1818997265765980370,
    11564556829023798017,
    17794704924608978109,
    1376674649968811740,
    4998026674621396600,
    12681505669819278274,
    14921295051649274677,
    7730289871405908311,
    9938718589984966213,
    16177155247494297750,
    5343147614569632249,
    7672888407744076994,
    14877451487164045105,
    14005025444814640803,
    12172719185709812426,
    13203579254948694740,
    8406704428887051297,
    9501490659269356059,
    614222297377807981,
    12422788712625837458,
    8186366159767297766,
    12259637792849826249,
    10296568637864271524,
    1788551870786484534,
    13726478862321504928,
    3181312767335684202,
    10195976123019403683,
    8660249931482289196,
    13363428754345285826,
    7127389693468702497,
    7162004714283466799,
    2060534948353415951,
    9453764044195488965,
    9881443448890516172,
    16758947935807665774,
    4799700133979698357,
    9174652887844599140,
    12284001838369612986,
    8704473696852721004,
    8231089251108884686,
    15396712207035521616,
    10468386372686078533,
    6191602336040557788,
    17507106165407860675,
    6590381886424984206,
    2097353080626035293,
    18170604579872022232,
    870543723121211938,
    12799528193212894058,
    4210642647498183275,
    523989058744318621,
    13646734495628710944,
    8922359812827620176,
    1224057547574382708,
    11777212629537403738,
    13498413648759595649,
    7285493403635358517,
    14914868291498337545,
    5141217423142932682,
    18309479319773526006,
    1368150857687430419,
    6026537533880520192,
    15913701447656602476,
    5562137220738404830,
    17650493971762198759,
    462698727905158503,
    12388230286900120739,
    1755755336595487290,
    4492270687140745746,
    17062320950246803119,
    2545358427568850894,
    4058502734962242391,
    13934590302227041427,
    3824786599390625818,
    8925202068453359493,
    60136518222910001,
    9851921075129985539,
    5033689773122645551,
    6258941976899979670,
    12586931443258695289,
    8314547922889758934,
    2862113869329532904,
    8487023037097889087,
    7755492867453584001,
    13412677069468383578,
    17055722199533992207,
    3337698368278236525,
    10590167612458150046,
    16324402354413311383,
    17368218863924005749,
    15908138381976666420,
    8346400952538226560,
    8124817201017376273,
    13356322833178298776,
    6093882765560439244,
    4949423843900030321,
    9637765303393667186,
    13990324967662486720,
    7726111284172824236,
    267929622392769373,
    5662420592220433726,
    5888955874135310995,
    10755402535213082023,
    15923809734452627792,
    13115401224780139458,
    9530993270094273467,
    2976446610739874191,
    3238343219180311038,
    7677133223987613852,
    5112271533789006591,
    11449460345549664567,
    13875742200454727322,
    14018060146074151448,
    7246054809467341059,
    15484568420007934104,
    13104266752980253141,
    15685763604006273993,
    10745278645964002862,
    9685012327456510689,
    8939651683887092224,
    10098948636054677936,
    1878488824999873646,
    14678674861831101337,
    3552840584580916553,
    14055798087199700170,
    14463862965099382845,
    720330479589527827,
    16148455834660080582,
    17732184503298087294,
    7925669605030937983,
    8214232923769010681,
    9795237372460346293,
    9726062421398328345,
    9777652686720354270,
    17070395834409443955,
    14094103167681589907,
    13397455947031300366,
    4809493837181629013,
    16094128368613023351,
    8681555505019235922,
    4127753223437817316,
    12692445065320515044,
    2965847459692143923,
    12767519376966935850,
    17565175606627906568,
    17794759314325512923,
    6231407634089262704,
    7393670613892637366,
    10822542063796899794,
    4133794479273129447,
    5703130874689871487,
    3511851354643556731,
    10871081953223501589,
    12079162073110233088,
    12683733697669520219,
    509230735822873485,
    15325113146678370579,
    5825109670928934096,
    18304416040830725354,
    2389732949252766864,
    2637433096506522179,
    10983645722555649415,
    8521166739035869008,
    16645631956649197166,
    7887539522831407900,
    2595006735858413481,
    13015455625583257849,
    4427218883350414881,
    11960086961550596695,
    17093573415602565966,
    14895816316078929338,
    964483869105984404,
    5521454861908568460,
    10165185110533374599,
    6285692914674974597,
    8667580087956142532,
    849253441004303539,
    7328527574408097658,
    6160472150963781980,
    10859225994285214481,
    6949489451967331247,
    9683404994470840432,
    16382260648173355471,
    14511916449861291873,
    12497643692555784590,
    8671890331985246139,
    3566026244291105874,
    15262309358638878965,
    13634220261873091017,
    9160786417339320544,
    4705871814950237403,
    17247703219513594750,
    5813864374358652852,
    174266216318462444,
    10054567187285748782,
    15779694002431618178,
    17451882347618708903,
    17584221348520821319,
    3147555573954081718,
    3892344672820524295,
    6427583109034938207,
    13897447896942825096,
    7417094030299429083,
    7450328789681328415,
    3148422128922906000,
    12983850060029764095,
    16520521496006519299,
    7077285945404973234,
    16371815151083448723,
    11494478140866499343,
    14090286741678037925,
    655531195106162492,
    18371704768896297817,
    15844402139184154176,
    4808131932052431373,
    243005581608519251,
    5341700268516771961,
    7923732189918021551,
    13599692745758041335,
    18264106060102296402,
    6662229222921344215,
    4431291525697268321,
    16669578369752367008,
    5956551273458262469,
    11038047216058437285,
    3289947358232769054,
    12849476465010649798,
    16140064008238446669,
    10190698693214998442,
    17484036322501148119,
    7384602872618573365,
    1232673998627441076,
    17078430113111973614,
    2760703954583699364,
    10180149497461882157,
    6565878897765308227,
    14358675218296331362,
    6894099486560564783,
    11832081010475921425,
    297657197573759165,
];
const BLACK_TURN_MASK: Hash = 17474137043024170843;
const CASTLING_MASK: [Hash; 16] = [
    17015797498412307685,
    15030233382288612429,
    12886200311607604472,
    15915161813474137999,
    7740346303548784910,
    18414070349819539343,
    1133573253303384279,
    3549895615096681176,
    15106753038606995957,
    3411534667350215627,
    14232378919834612621,
    5758064505904550206,
    1909294005430415198,
    9986680597585565477,
    13949589920445030062,
    17954563369053156872,
];
const EN_PASSANT_MASK: [Hash; 8] = [
    13603084972066601446,
    12820131582243414668,
    3130618090649204130,
    12989964341493562357,
    853790625002385948,
    4229067576451552334,
    2011071859289862864,
    3904018615231405027,
];